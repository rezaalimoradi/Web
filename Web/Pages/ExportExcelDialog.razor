@inherits ComponentBase
@using OfficeOpenXml
@using Radzen
@using Radzen.Blazor
@using global::Shared.Dtos.User
@inject DialogService Dialog
@inject IJSRuntime JS

<div class="p-3">
    <h4>دانلود Excel</h4>

    <RadzenButton Text="دانلود Excel" Icon="table_view" Click="GenerateExcel"
                  ButtonStyle="ButtonStyle.Primary" />
    <RadzenButton Text="بستن" Click="Close" Class="ml-2" />
</div>

@code {
    [Parameter] public List<UserDto> Users { get; set; }

    private async Task GenerateExcel()
    {
        ExcelPackage.LicenseContext = LicenseContext.NonCommercial;

        using var package = new ExcelPackage();
        var sheet = package.Workbook.Worksheets.Add("Users");

        sheet.Cells["A1"].Value = "UserName";
        sheet.Cells["B1"].Value = "Email";

        for (int i = 0; i < Users.Count; i++)
        {
            sheet.Cells[i + 2, 1].Value = Users[i].UserName;
            sheet.Cells[i + 2, 2].Value = Users[i].Email;
        }

        var bytes = package.GetAsByteArray();
        await using var stream = new MemoryStream(bytes);
        await JS.InvokeVoidAsync("downloadFileFromStream", "users.xlsx", stream);
    }

    void Close() => Dialog.Close();
}
