@page "/login"
@using global::Shared.Dtos.User
@inject IHasibApi Api
@inject TokenProvider TokenProvider
@inject NavigationManager Nav

<style>
    /* صفحه لاگین وسط صفحه */
    .login-page {
        position: fixed;
        inset: 0;
        background: #f5f7fa;
        padding: 20px;
    }

    /* جعبه فرم */
    .login-box {
        width: 100%;
        max-width: 380px;
        background: white;
        border-radius: 12px;
    }
</style>

<div class="login-page d-flex justify-content-center align-items-center">
    <div class="login-box shadow-lg p-4 rounded">

        <h3 class="text-center mb-4">ورود به سیستم</h3>

        <div class="mb-3">
            <input class="form-control"
                   @bind="username"
                   placeholder="نام کاربری" />
        </div>

        <div class="mb-3">
            <input class="form-control"
                   @bind="password"
                   type="password"
                   placeholder="رمز عبور" />
        </div>

        <button class="btn btn-primary w-100"
                @onclick="LoginAsync"
                disabled="@isLoading">
            @(isLoading ? "لطفا صبور باشید..." : "ورود")
        </button>

        @if (!string.IsNullOrWhiteSpace(message))
        {
            <div class="alert alert-danger mt-3 text-center">
                @message
            </div>
        }

    </div>
</div>

@code {
    private string username = "";
    private string password = "";
    private string message = "";
    private bool isLoading = false;

    private async Task LoginAsync()
    {
        message = "";
        isLoading = true;

        try
        {
            var result = await Api.LoginAsync(new LoginRequest
            {
                Username = username,
                Password = password
            });

            if (!result.IsSuccessStatusCode || result.Content == null)
            {
                message = "❌ نام کاربری یا رمز عبور اشتباه است";
                return;
            }

            var token = result.Content.Token;

            await TokenProvider.SetTokenAsync(token);

            Nav.NavigateTo("/", true);
        }
        catch (Exception ex)
        {
            message = $"❌ خطا: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
